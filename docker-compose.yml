# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
# Pi-hole v6 on Synology NAS (macvlan network)
#
# Pi-hole v6 (February 2025+) uses Alpine base image and FTLCONF_ environment variables.
# All settings via environment variables are READ-ONLY (cannot be changed via web UI).
#
# Pi-hole gets its own IP on the LAN via macvlan.
# This avoids port conflicts with DSM and gives DNS a dedicated address.
#
# Prerequisites:
#   1. Install Container Manager 24.0.2+ from DSM Package Center (DSM 7.2+)
#   2. Create data directories:
#      sudo mkdir -p /volume1/docker/pihole/{etc-pihole,etc-dnsmasq.d}
#   3. Copy .env.example to .env and set PIHOLE_PASSWORD
#   4. Edit this file to match your network (see CONFIGURATION section below)
#
# Usage:
#   docker-compose up -d
#   # or with new syntax:
#   docker compose up -d
#
# Web UI:
#   http://<PIHOLE_IP>/admin
#
# Upgrade notes:
#   https://docs.pi-hole.net/docker/upgrading/v5-v6/

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    restart: unless-stopped
    hostname: pihole
    networks:
      pihole_net:
        # ════════════════════════════════════════════════════════════
        # CONFIGURATION: Set your Pi-hole's IP address here
        # ════════════════════════════════════════════════════════════
        # Pick an unused IP on your LAN (outside DHCP range).
        # Example: 192.168.1.53 (matching DNS port)
        ipv4_address: 192.168.1.53
    environment:
      TZ: ${TZ:-UTC}
      FTLCONF_webserver_api_password: ${PIHOLE_PASSWORD:-}
      FTLCONF_dns_upstreams: '1.1.1.1;1.0.0.1'    # Cloudflare (change if preferred); use semicolon for multiple
      FTLCONF_dns_listeningMode: all
      FTLCONF_misc_etc_dnsmasq_d: 'true'           # Pi-hole v6: Enable /etc/dnsmasq.d/ config files (disabled by default)
      DNSMASQ_USER: root    # Required on Synology — see pihole/docker-pi-hole#963
    volumes:
      - /volume1/docker/pihole/etc-pihole:/etc/pihole
      - /volume1/docker/pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    dns:
      - 127.0.0.1       # Pi-hole uses itself for DNS
      - 1.1.1.1          # Fallback during container startup

networks:
  pihole_net:
    driver: macvlan
    driver_opts:
      # ════════════════════════════════════════════════════════════
      # CONFIGURATION: Set your NAS's network interface here
      # ════════════════════════════════════════════════════════════
      # Check with: ssh your-nas "ip addr"
      # Common values: eth0, eth1, bond0
      parent: eth0
    ipam:
      config:
        # ════════════════════════════════════════════════════════════
        # CONFIGURATION: Set your LAN network details here
        # ════════════════════════════════════════════════════════════
        - subnet: 192.168.1.0/24       # Your LAN subnet
          gateway: 192.168.1.1          # Your router/gateway IP
          ip_range: 192.168.1.53/32     # Pi-hole's IP (must match ipv4_address above)
                                         # /32 restricts Docker to exactly this one IP
